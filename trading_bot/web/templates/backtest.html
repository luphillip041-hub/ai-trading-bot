{% extends "base.html" %}
{% set active_page = "backtest" %}

{% block title %}Backtest - AI Trading Bot{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Backtester</h1>
        <p class="mt-1 text-sm text-gray-500">Test trading strategies against historical data and see detailed performance metrics.</p>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
        <div class="flex flex-wrap gap-4 items-end">
            <div class="w-40">
                <label class="block text-sm font-medium text-gray-700 mb-1">Ticker</label>
                <input id="ticker" type="text" value="AAPL"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none uppercase"
                    placeholder="AAPL">
            </div>
            <div class="w-36">
                <label class="block text-sm font-medium text-gray-700 mb-1">Period</label>
                <select id="period" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
                    <option value="3mo">3 Months</option>
                    <option value="6mo">6 Months</option>
                    <option value="1y" selected>1 Year</option>
                    <option value="2y">2 Years</option>
                    <option value="5y">5 Years</option>
                </select>
            </div>
            <div class="w-44">
                <label class="block text-sm font-medium text-gray-700 mb-1">Initial Capital</label>
                <input id="capital" type="number" value="100000"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none"
                    placeholder="100000">
            </div>
            <button id="btBtn" onclick="runBacktest()"
                class="px-6 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700 transition-colors shadow-sm">
                Run Backtest
            </button>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden text-center py-12">
        <div class="loader mx-auto mb-3"></div>
        <p class="text-sm text-gray-500">Running backtest simulation...</p>
    </div>

    <!-- Results -->
    <div id="results" class="hidden space-y-6 fade-in">
        <!-- Metrics Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="metricsGrid"></div>

        <!-- Equity Curve Chart -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Equity Curve</h2>
            <div class="h-80">
                <canvas id="equityChart"></canvas>
            </div>
        </div>

        <!-- Price + Trades Chart -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Price & Trade Signals</h2>
            <div class="h-80">
                <canvas id="priceChart"></canvas>
            </div>
        </div>

        <!-- Trade Log -->
        <div id="tradeLogSection" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Trade Log</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Date</th>
                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Action</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Price</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Strength</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">P&L</th>
                        </tr>
                    </thead>
                    <tbody id="tradeLog" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let equityChartInstance = null;
let priceChartInstance = null;

async function runBacktest() {
    const ticker = document.getElementById('ticker').value.toUpperCase();
    const period = document.getElementById('period').value;
    const capital = document.getElementById('capital').value;

    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('results').classList.add('hidden');
    document.getElementById('btBtn').disabled = true;
    document.getElementById('btBtn').textContent = 'Running...';

    try {
        const res = await fetch(`/api/backtest/${ticker}?period=${period}&capital=${capital}`);
        const data = await res.json();
        if (data.error) {
            alert(data.error);
            return;
        }
        renderBacktest(data, ticker);
    } catch (err) {
        alert('Error: ' + err.message);
    } finally {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('btBtn').disabled = false;
        document.getElementById('btBtn').textContent = 'Run Backtest';
    }
}

function renderBacktest(data, ticker) {
    const s = data.summary;
    const returnColor = s.total_return_pct >= 0 ? 'text-green-600 border-green-200' : 'text-red-600 border-red-200';

    document.getElementById('metricsGrid').innerHTML = `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Final Value</div>
            <div class="text-2xl font-bold ${s.total_return_pct >= 0 ? 'text-green-600' : 'text-red-600'} mt-1">$${s.final_value.toLocaleString()}</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border ${returnColor} p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Return</div>
            <div class="text-2xl font-bold ${s.total_return_pct >= 0 ? 'text-green-600' : 'text-red-600'} mt-1">${s.total_return_pct >= 0 ? '+' : ''}${s.total_return_pct}%</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Win Rate</div>
            <div class="text-2xl font-bold text-gray-900 mt-1">${s.win_rate_pct}%</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Sharpe Ratio</div>
            <div class="text-2xl font-bold text-gray-900 mt-1">${s.sharpe_ratio}</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Max Drawdown</div>
            <div class="text-2xl font-bold text-red-600 mt-1">${s.max_drawdown_pct}%</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Total Trades</div>
            <div class="text-2xl font-bold text-gray-900 mt-1">${s.total_trades}</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-green-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Winners</div>
            <div class="text-2xl font-bold text-green-600 mt-1">${s.winning_trades}</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-red-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Losers</div>
            <div class="text-2xl font-bold text-red-600 mt-1">${s.losing_trades}</div>
        </div>
    `;

    // Equity curve chart
    const ec = data.equity_curve;
    const labels = ec.map(p => p.date.substring(0, 10));
    const equities = ec.map(p => p.equity);

    if (equityChartInstance) equityChartInstance.destroy();
    equityChartInstance = new Chart(document.getElementById('equityChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Portfolio Value',
                data: equities,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99,102,241,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 0,
                borderWidth: 2,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: true, ticks: { maxTicksLimit: 10, font: { size: 11 } }, grid: { display: false } },
                y: { display: true, ticks: { callback: v => '$' + v.toLocaleString(), font: { size: 11 } }, grid: { color: '#f3f4f6' } }
            },
            interaction: { intersect: false, mode: 'index' },
        }
    });

    // Price chart with buy/sell markers
    const prices = ec.map(p => p.price);
    const buyPoints = ec.map((p, i) => {
        const trade = data.signals_log.find(t => t.date.substring(0, 10) === p.date.substring(0, 10) && (t.action === 'BUY'));
        return trade ? p.price : null;
    });
    const sellPoints = ec.map((p, i) => {
        const trade = data.signals_log.find(t => t.date.substring(0, 10) === p.date.substring(0, 10) && (t.action === 'SELL' || t.action === 'STOP_LOSS' || t.action === 'TAKE_PROFIT'));
        return trade ? p.price : null;
    });

    if (priceChartInstance) priceChartInstance.destroy();
    priceChartInstance = new Chart(document.getElementById('priceChart'), {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: `${ticker} Price`,
                    data: prices,
                    borderColor: '#6b7280',
                    tension: 0.3,
                    pointRadius: 0,
                    borderWidth: 1.5,
                },
                {
                    label: 'Buy',
                    data: buyPoints,
                    borderColor: '#10b981',
                    backgroundColor: '#10b981',
                    pointRadius: 6,
                    pointStyle: 'triangle',
                    showLine: false,
                },
                {
                    label: 'Sell',
                    data: sellPoints,
                    borderColor: '#ef4444',
                    backgroundColor: '#ef4444',
                    pointRadius: 6,
                    pointStyle: 'triangle',
                    pointRotation: 180,
                    showLine: false,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top', labels: { font: { size: 11 } } } },
            scales: {
                x: { ticks: { maxTicksLimit: 10, font: { size: 11 } }, grid: { display: false } },
                y: { ticks: { callback: v => '$' + v.toFixed(2), font: { size: 11 } }, grid: { color: '#f3f4f6' } }
            },
            interaction: { intersect: false, mode: 'index' },
        }
    });

    // Trade log
    const tradeLog = document.getElementById('tradeLog');
    if (data.signals_log.length > 0) {
        tradeLog.innerHTML = data.signals_log.map(t => {
            const actionColors = { BUY: 'text-green-600 bg-green-50', SELL: 'text-red-600 bg-red-50', STOP_LOSS: 'text-red-700 bg-red-100', TAKE_PROFIT: 'text-green-700 bg-green-100' };
            const ac = actionColors[t.action] || 'text-gray-600 bg-gray-50';
            const pnl = t.pnl !== undefined ? (t.pnl >= 0 ? `<span class="text-green-600">+$${t.pnl.toFixed(2)}</span>` : `<span class="text-red-600">-$${Math.abs(t.pnl).toFixed(2)}</span>`) : '-';
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-5 py-3 text-sm text-gray-600">${t.date.substring(0, 10)}</td>
                    <td class="px-5 py-3"><span class="inline-flex px-2.5 py-0.5 rounded-full text-xs font-semibold ${ac}">${t.action}</span></td>
                    <td class="px-5 py-3 text-right font-mono text-sm">$${t.price.toFixed(2)}</td>
                    <td class="px-5 py-3 text-right text-sm">${(t.signal_strength * 100).toFixed(0)}%</td>
                    <td class="px-5 py-3 text-right text-sm font-medium">${pnl}</td>
                </tr>`;
        }).join('');
    }

    document.getElementById('results').classList.remove('hidden');
}
</script>
{% endblock %}
