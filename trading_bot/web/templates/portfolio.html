{% extends "base.html" %}
{% set active_page = "portfolio" %}

{% block title %}Portfolio - AI Trading Bot{% endblock %}

{% block content %}
<div class="space-y-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Portfolio Simulator</h1>
        <p class="mt-1 text-sm text-gray-500">Simulate a portfolio based on current algorithmic signals with automatic position sizing and risk management.</p>
    </div>

    <!-- Controls -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
        <div class="flex flex-wrap gap-4 items-end">
            <div class="flex-1 min-w-64">
                <label class="block text-sm font-medium text-gray-700 mb-1">Tickers</label>
                <input id="tickers" type="text" value="AAPL,MSFT,GOOGL,NVDA,AMZN,META,TSLA"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none"
                    placeholder="AAPL,MSFT,GOOGL...">
            </div>
            <div class="w-44">
                <label class="block text-sm font-medium text-gray-700 mb-1">Initial Capital</label>
                <input id="capital" type="number" value="100000"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500 outline-none">
            </div>
            <button id="simBtn" onclick="runSimulation()"
                class="px-6 py-2 bg-brand-600 text-white rounded-lg text-sm font-medium hover:bg-brand-700 transition-colors shadow-sm">
                Run Simulation
            </button>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="hidden text-center py-12">
        <div class="loader mx-auto mb-3"></div>
        <p class="text-sm text-gray-500">Analyzing signals and building portfolio...</p>
    </div>

    <!-- Results -->
    <div id="results" class="hidden space-y-6 fade-in">
        <!-- Summary -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4" id="summaryGrid"></div>

        <!-- Allocation Chart -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Portfolio Allocation</h2>
                <div class="h-64 flex items-center justify-center">
                    <canvas id="allocationChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Signal Overview</h2>
                <div id="signalOverview" class="space-y-2"></div>
            </div>
        </div>

        <!-- Positions Table -->
        <div id="positionsSection" class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Open Positions</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Ticker</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Shares</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Entry</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Current</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">P&L</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">P&L %</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Stop Loss</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Take Profit</th>
                        </tr>
                    </thead>
                    <tbody id="positionsTable" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let allocationChartInstance = null;

async function runSimulation() {
    const tickers = document.getElementById('tickers').value;
    const capital = document.getElementById('capital').value;

    document.getElementById('loading').classList.remove('hidden');
    document.getElementById('results').classList.add('hidden');
    document.getElementById('simBtn').disabled = true;
    document.getElementById('simBtn').textContent = 'Running...';

    try {
        const res = await fetch(`/api/portfolio?tickers=${encodeURIComponent(tickers)}&capital=${capital}`);
        const data = await res.json();
        renderPortfolio(data);
    } catch (err) {
        alert('Error: ' + err.message);
    } finally {
        document.getElementById('loading').classList.add('hidden');
        document.getElementById('simBtn').disabled = false;
        document.getElementById('simBtn').textContent = 'Run Simulation';
    }
}

function renderPortfolio(data) {
    const s = data.summary;
    const pnlColor = s.total_pnl >= 0 ? 'text-green-600' : 'text-red-600';
    const pnlBorder = s.total_pnl >= 0 ? 'border-green-200' : 'border-red-200';

    document.getElementById('summaryGrid').innerHTML = `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Cash</div>
            <div class="text-2xl font-bold text-gray-900 mt-1">$${s.cash.toLocaleString()}</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Total Value</div>
            <div class="text-2xl font-bold text-gray-900 mt-1">$${s.total_value.toLocaleString()}</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border ${pnlBorder} p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">P&L</div>
            <div class="text-2xl font-bold ${pnlColor} mt-1">${s.total_pnl >= 0 ? '+' : ''}$${s.total_pnl.toFixed(2)}</div>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
            <div class="text-xs text-gray-500 uppercase tracking-wider">Positions</div>
            <div class="text-2xl font-bold text-gray-900 mt-1">${s.positions_count}</div>
        </div>
    `;

    // Allocation pie chart
    const positions = data.positions;
    if (positions.length > 0) {
        const posLabels = positions.map(p => p.ticker);
        const posValues = positions.map(p => p.shares * p.current_price);
        posLabels.push('Cash');
        posValues.push(s.cash);

        const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#84cc16', '#94a3b8'];

        if (allocationChartInstance) allocationChartInstance.destroy();
        allocationChartInstance = new Chart(document.getElementById('allocationChart'), {
            type: 'doughnut',
            data: {
                labels: posLabels,
                datasets: [{
                    data: posValues,
                    backgroundColor: colors.slice(0, posLabels.length),
                    borderWidth: 2,
                    borderColor: '#fff',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { size: 11 }, padding: 12 } },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.label}: $${ctx.parsed.toLocaleString(undefined, {minimumFractionDigits: 2})}` } }
                }
            }
        });
    }

    // Signal overview
    const signalOverview = document.getElementById('signalOverview');
    signalOverview.innerHTML = data.signals.map(sig => {
        const sigClass = sig.signal === 'BUY' ? 'signal-buy' : sig.signal === 'SELL' ? 'signal-sell' : 'signal-hold';
        return `
            <div class="flex items-center justify-between px-3 py-2 rounded-lg bg-gray-50">
                <div class="flex items-center gap-3">
                    <span class="font-semibold text-gray-900 w-14">${sig.ticker}</span>
                    <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-semibold ${sigClass}">${sig.signal}</span>
                </div>
                <div class="text-right">
                    <span class="font-mono text-sm text-gray-600">$${sig.price.toFixed(2)}</span>
                    <span class="text-xs text-gray-400 ml-2">${(sig.strength * 100).toFixed(0)}%</span>
                </div>
            </div>`;
    }).join('');

    // Positions table
    const posTable = document.getElementById('positionsTable');
    if (positions.length > 0) {
        posTable.innerHTML = positions.map(p => {
            const pColor = p.pnl >= 0 ? 'text-green-600' : 'text-red-600';
            return `
                <tr class="hover:bg-gray-50">
                    <td class="px-5 py-3 font-semibold text-gray-900">${p.ticker}</td>
                    <td class="px-5 py-3 text-right font-mono text-sm">${p.shares}</td>
                    <td class="px-5 py-3 text-right font-mono text-sm">$${p.entry_price.toFixed(2)}</td>
                    <td class="px-5 py-3 text-right font-mono text-sm">$${p.current_price.toFixed(2)}</td>
                    <td class="px-5 py-3 text-right font-mono text-sm ${pColor}">${p.pnl >= 0 ? '+' : ''}$${p.pnl.toFixed(2)}</td>
                    <td class="px-5 py-3 text-right font-mono text-sm ${pColor}">${p.pnl_pct >= 0 ? '+' : ''}${p.pnl_pct.toFixed(2)}%</td>
                    <td class="px-5 py-3 text-right font-mono text-sm text-red-500">$${p.stop_loss.toFixed(2)}</td>
                    <td class="px-5 py-3 text-right font-mono text-sm text-green-500">$${p.take_profit.toFixed(2)}</td>
                </tr>`;
        }).join('');
    } else {
        posTable.innerHTML = '<tr><td colspan="8" class="px-5 py-8 text-center text-sm text-gray-400">No positions opened - no BUY signals met consensus threshold</td></tr>';
    }

    document.getElementById('results').classList.remove('hidden');
}
</script>
{% endblock %}
